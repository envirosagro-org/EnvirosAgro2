rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // --- CORE ENVIROSAGRO HELPER FUNCTIONS ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isVideo() {
      return request.resource.contentType.matches('video/.*');
    }

    function isAudio() {
      return request.resource.contentType.matches('audio/.*');
    }

    function isDocument() {
      return request.resource.contentType.matches('application/pdf') || 
             request.resource.contentType.matches('text/plain') ||
             request.resource.contentType.matches('application/msword') ||
             request.resource.contentType.matches('application/vnd.openxmlformats-officedocument.wordprocessingml.document');
    }

    // --- STORAGE PROTOCOLS ---

    // 1. Stewards Directory: Avatars and Dossier elements
    match /stewards/{userId}/{allPaths=**} {
      allow read: if isSignedIn();
      allow write: if isOwner(userId)
                   && request.resource.size < 10 * 1024 * 1024 // 10MB Limit
                   && (isImage() || isDocument());
    }

    // 2. Evidence Vault: Digital MRV and Field Proofs
    match /evidence/{userId}/{fileName} {
      allow read: if isSignedIn(); // Auditable by the mesh
      allow create: if isOwner(userId)
                    && request.resource.size < 20 * 1024 * 1024 // 20MB Limit
                    && (isImage() || isDocument());
      allow update, delete: if false; // Immutable Evidence Sharding
    }

    // 3. Media Ledger: Cinema, Audio Waveforms, and Knowledge Shards
    match /media_shards/{shardId} {
      allow read: if true; // Publicly accessible to the Githaka quorum
      allow create: if isSignedIn()
                    && (
                      (isVideo() && request.resource.size < 100 * 1024 * 1024) || // 100MB Video
                      (isAudio() && request.resource.size < 50 * 1024 * 1024) ||  // 50MB Audio
                      (isDocument() && request.resource.size < 25 * 1024 * 1024)   // 25MB Paper
                    );
      allow update, delete: if false; // Registry finality
    }

    // 4. Industrial Ingest: Automated Telemetry Buffers
    match /ingest/{esin}/{allPaths=**} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() 
                   && request.resource.size < 5 * 1024 * 1024
                   && (isDocument() || request.resource.contentType == 'application/json');
    }
  }
}